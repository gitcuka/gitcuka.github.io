<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
{% if page.title %}
  {{ page.title }} | {{ site.title }}
{% else %}
  {{ site.title }}
{% endif %}
</title>
<meta name="description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">
  <link rel="canonical" href="{{ page.url | absolute_url }}">
  <link rel="icon" href="{{ '/assets/gitcuka.jpg' | relative_url }}">
  <meta property="og:title" content="{{ page.title | gitcuka: site.title }}">
  <meta property="og:description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">
  <meta property="og:url" content="{{ page.url | absolute_url }}">
  <meta property="og:site_name" content="{{ site.title }}">
  <meta property="og:type" content="{% if page.layout == 'gitcukapost' %}article{% else %}website{% endif %}">
  <meta property="og:image" content="{% if page.thumbnail %} {{ page.thumbnail | absolute_url }} {% else %} {{ site.url }}/assets/gitcuka.jpg {% endif %}">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="{{ page.title | gitcuka: site.title }}">
  <meta name="twitter:description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">
  <meta name="twitter:image" content="{% if page.thumbnail %} {{ page.thumbnail | absolute_url }} {% else %} {{ site.url }}/assets/gitcuka.jpg {% endif %}">
  <link rel="alternate" type="application/atom+xml" title="{{ site.title }}" href="{{ '/feed.xml' | relative_url }}">
  <link rel="sitemap" type="application/xml" title="Sitemap" href="{{ '/sitemap.xml' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/gitcukastyles.css' | relative_url }}">
  {%- seo -%}
  <meta name="google-site-verification" content="lGwFajYY5MSjoPWpB788RrOYyqEigrGLEmKUUxHrLfQ" />
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-V5H15HGP0W"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-V5H15HGP0W');
</script>
</head>

<body>
{% include livechat.html %}
{% include sidebar-left.html %}

<header class="site-header">
  <button class="menu-toggle" onclick="toggleMenu()">☰</button>
  <div>
    <strong>{{ site.title }}</strong><br>
    <small>{{ site.description }}</small>
  </div>
</header>

<div class="site-wrapper">

  <div class="content-wrapper">

    <main>
      {{ content }}
    </main>

    <aside class="sidebar-right">

  <h3>Cari Postingan</h3>

  <input
    type="text"
    id="searchInput"
    placeholder="Ketik judul postingan..."
  >

  <ul id="searchResults"></ul>

    </aside>

  </div>

  <footer>
    © {{ site.time | date: "%Y" }} {{ site.title }}
  </footer>

</div>

<script>
function toggleMenu() {
  document.getElementById("sidebar").classList.toggle("active");
}

const posts = [
  {% for post in site.posts %}
  {
    title: "{{ post.title | escape }}",
    url: "{{ post.url | relative_url }}"
  }{% unless forloop.last %},{% endunless %}
  {% endfor %}
];

const searchInput = document.getElementById("searchInput");
const searchResults = document.getElementById("searchResults");

searchInput.addEventListener("input", function () {
  const keyword = this.value.toLowerCase();
  searchResults.innerHTML = "";

  if (keyword.length < 2) return;

  const results = posts.filter(post =>
    post.title.toLowerCase().includes(keyword)
  );

  if (results.length === 0) {
    searchResults.innerHTML = "<li>Tidak ditemukan</li>";
    return;
  }

  results.forEach(post => {
    const li = document.createElement("li");
    const a = document.createElement("a");
    a.href = post.url;
    a.textContent = post.title;
    li.appendChild(a);
    searchResults.appendChild(li);
  });
});

</script>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  const toggle = document.getElementById("chat-toggle");
  const chat = document.getElementById("chat-container");
  const close = document.getElementById("chat-close");
chat.style.display = "none";
  toggle.onclick = () => {
    chat.style.display = "flex";
    toggle.style.display = "none";
  };

  close.onclick = () => {
    chat.style.display = "none";
    toggle.style.display = "flex";
  };
});
  </script>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        
        // GANTI DENGAN KONFIGURASI PROYEK ANDA!
        const firebaseConfig = {
    apiKey: "AIzaSyAaB1oF3JLV2macQrMJzmJhTl53dyUqCWM",
    authDomain: "gitcuka-chat.firebaseapp.com",
    projectId: "gitcuka-chat",
    storageBucket: "gitcuka-chat.firebasestorage.app",
    messagingSenderId: "443390519338",
    appId: "1:443390519338:web:39eb50d75e7f01284fbb53",
    measurementId: "G-QTDQE3DKY1"
  };

        // Inisialisasi Firebase dan membuatnya tersedia secara global
        const app = initializeApp(firebaseConfig);
        window.firebaseApp = app; 
</script>
  
<script type="module">
  // --- Import Fungsi Firestore yang Dibutuhkan ---
import { 
    getFirestore, 
    collection, 
    addDoc, 
    onSnapshot, 
    query, 
    orderBy, 
    serverTimestamp,
    limit,
    where,
    getDocs,
    writeBatch
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// --- KONSTANTA & VARIABEL GLOBAL ---
const MAX_MESSAGES = 2; // Batas pesan yang disimpan per room
let currentRoomId = 'all'; // Room default saat start
let unsubscribeListener; // Fungsi untuk menghentikan listener real-time

// --- Inisialisasi Firebase & Firestore ---
const app = window.firebaseApp; 
if (!app) {
    console.error("Firebase App belum diinisialisasi.");
    throw new Error("Firebase App is not initialized."); 
}

const db = getFirestore(app); 
const chatsCol = collection(db, 'chats'); 

// Elemen DOM
const messageForm = document.getElementById('message-form');
const usernameInput = document.getElementById('username-input');
const messageInput = document.getElementById('message-input');
const messagesList = document.getElementById('messages');
const roomButtons = document.querySelectorAll('#room-selection button');


// --- Fungsi Pembantu: Membuat Elemen Pesan ---
function createMessageElement(data) {
    const messageElement = document.createElement('li');
    let timeString = '';
    
    // Format Tanggal dan Waktu
    if (data.timestamp && data.timestamp.toDate) {
        const date = data.timestamp.toDate();
        const options = {
            year: 'numeric', 
            month: 'short', 
            day: '2-digit', 
            hour: '2-digit', 
            minute: '2-digit'
        };
        timeString = date.toLocaleDateString('id-ID', options);
    } else {
        timeString = 'Baru saja dikirim...'; 
    }

    messageElement.innerHTML = `
        <div class="message-content">
            <small class="message-time">${timeString}</small>
            <strong>${data.username}</strong>: ${data.text}
        </div>
    `;

    // Asumsi: Semua pesan adalah 'message-other' karena tidak ada Authentication
    // Jika Anda ingin mengimplementasikan self vs other, Anda perlu menyimpan ID pengguna
    // dan membandingkannya di sini.
    messageElement.classList.add('message-other'); 
    
    return messageElement;
}

// --- Fungsi 1: Cleanup Pesan Terlama ---
async function cleanupOldMessages(roomId) {
    try {
        const cleanupQuery = query(
            chatsCol, 
            where('roomId', '==', roomId), // Hapus hanya di room ini
            orderBy('timestamp', 'asc'), 
            limit(MAX_MESSAGES + 5) 
        );

        const snapshot = await getDocs(cleanupQuery);
        const totalMessages = snapshot.size;

        if (totalMessages > MAX_MESSAGES) {
            const countToDelete = totalMessages - MAX_MESSAGES;
            console.log(`[Room ${roomId}] Batas terlampaui. Menghapus ${countToDelete} pesan terlama.`);
            
            const batch = writeBatch(db);
            
            for (let i = 0; i < countToDelete; i++) {
                const docToDelete = snapshot.docs[i];
                batch.delete(docToDelete.ref);
            }
            
            await batch.commit();
            console.log(`${countToDelete} pesan berhasil dihapus dari room ${roomId}.`);
        }
    } catch (error) {
        console.error("Gagal menjalankan cleanup pesan terlama:", error);
    }
}


// --- Fungsi 2: Mengatur Ulang Listener (Room Selector) ---
function setupChatListener(roomId) {
    // 1. Hentikan listener yang aktif sebelumnya
    if (unsubscribeListener) {
        unsubscribeListener();
    }
    
    // 2. Kosongkan tampilan chat
    messagesList.innerHTML = ''; 

    // 3. Buat query BARU yang difilter
    const q = query(
        chatsCol, 
        where('roomId', '==', roomId), // Filter berdasarkan Room ID
        orderBy('timestamp', 'asc'), 
        limit(MAX_MESSAGES) // Tampilkan hanya MAX_MESSAGES terakhir
    );
    
    // 4. Mulai listener baru
    unsubscribeListener = onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            const docId = change.doc.id;
            const messageData = change.doc.data();
            let existingLi = document.getElementById(docId);

            if (change.type === 'added') {
                const messageElement = createMessageElement(messageData);
                messageElement.id = docId; 
                messagesList.appendChild(messageElement);
                
            } else if (change.type === 'modified' && existingLi) {
                // Update elemen ketika timestamp selesai
                const updatedElement = createMessageElement(messageData);
                existingLi.innerHTML = updatedElement.innerHTML; 
                
            } else if (change.type === 'removed' && existingLi) {
                // Hapus elemen yang dihapus oleh fungsi cleanup
                existingLi.remove();
            }
        });

        // Gulir ke bawah
        messagesList.scrollTop = messagesList.scrollHeight;
    }, (error) => {
        console.error("Error mendengarkan snapshot Firestore:", error.code, error.message);
        // Tampilkan peringatan jika terjadi error izin
        alert(`Gagal mengambil pesan di room ${roomId}. Pastikan Anda membuat index Firestore yang diperlukan!`);
    });
}


// --- Fungsi 3: Mengirim Pesan (POST) ---
messageForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const username = usernameInput.value.trim();
    const message = messageInput.value.trim();

    if (username && message) {
        const newMessage = {
            username: username,
            text: message,
            timestamp: serverTimestamp(),
            roomId: currentRoomId, // Kirim ke room yang sedang aktif
        };

        try {
            await addDoc(chatsCol, newMessage);
            messageInput.value = ''; 
            
            // Lakukan cleanup setelah pesan berhasil terkirim
            await cleanupOldMessages(currentRoomId);

        } catch (error) {
            console.error("Error mengirim pesan:", error);
            alert("Gagal mengirim pesan. Cek koneksi atau aturan keamanan.");
        }
    }
});


// --- Fungsi 4: Logika Pergantian Room ---
roomButtons.forEach(button => {
    button.addEventListener('click', (e) => {
        const newRoomId = e.target.dataset.room;
        
        // Update tampilan tombol
        roomButtons.forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        
        // Perbarui global dan ganti listener
        currentRoomId = newRoomId;
        setupChatListener(currentRoomId);
        
        console.log(`Pindah ke room: ${currentRoomId}`);
    });
});


// --- Panggil saat Halaman Pertama Kali Dimuat ---
setupChatListener(currentRoomId);

</script>
  
</body>
</html>
